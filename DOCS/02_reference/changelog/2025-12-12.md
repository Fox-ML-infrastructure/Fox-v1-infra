# Changelog — 2025-12-12

**Cohort-Aware Reproducibility System, RESULTS Directory Organization, Integrated Backups, Enhanced Metadata**

For a quick overview, see the [root changelog](../../../../CHANGELOG.md).  
For other dates, see the [changelog index](README.md).

---

## Added

### Cohort-Aware Reproducibility System

**Complete Implementation**
- Runs organized by data cohort (sample size, symbols, date range, config)
- Sample-adjusted drift detection using z-scores for statistically meaningful comparisons
- Only compares runs within the same cohort (prevents meaningless cross-cohort comparisons)
- Automatic cohort identification and matching
- `INCOMPARABLE` classification when cohorts differ significantly (n_ratio < 0.90)
- Default mode is cohort-aware (`cohort_aware=True` by default)

**Storage Structure**
- Hierarchical organization: `RESULTS/{cohort_id}/{run_name}/REPRODUCIBILITY/{STAGE}/{item_name}/cohort={cohort_id}/`
- Global `index.parquet` for fast lookups across all runs
- Operational metrics in `stats.json` for visibility
- Each cohort directory contains: `metadata.json`, `metrics.json`, `drift.json`

**Cohort ID Format**
- Readable format: `cs_2025Q2_min_cs3_max1000_v1_bdbeb515`
- Includes: mode prefix, date range (quarter), universe, config params, version, hash
- Deterministic hash ensures uniqueness while maintaining readability

**Sample-Adjusted Comparison**
- Variance estimation: `var = AUC * (1 - AUC) / N_effective`
- Z-score calculation: `z = (AUC_curr - AUC_prev) / sqrt(var_prev + var_curr)`
- Classification:
  - `|z| < 1` → **STABLE (sample-adjusted)**
  - `1 ≤ |z| < 2` → **DRIFTING (sample-adjusted)**
  - `|z| ≥ 2` → **DIVERGED (sample-adjusted)**
  - `n_ratio < 0.90` → **INCOMPARABLE**

**Files**:
- `TRAINING/utils/reproducibility_tracker.py` - Complete cohort-aware implementation
- `TRAINING/utils/cohort_metadata_extractor.py` - **NEW** - Unified metadata extraction utility

### RESULTS Directory Organization

**Automatic Organization**
- All runs (test and production) stored in `RESULTS/` directory
- Automatic cohort-based organization: `RESULTS/{cohort_id}/{run_name}/`
- Runs start in `RESULTS/_pending/{run_name}/` and automatically move to cohort directory after first target is processed
- Keeps root directory clean and organized

**Directory Flow**
1. Initial: `RESULTS/_pending/{run_name}_YYYYMMDD_HHMMSS/`
2. After first target: `RESULTS/{cohort_id}/{run_name}_YYYYMMDD_HHMMSS/`
3. All artifacts move together: `target_rankings/`, `feature_selections/`, `training_results/`, `backups/`, `REPRODUCIBILITY/`

**Benefits**
- Easy to find all runs for the same cohort
- Direct comparison of runs within the same cohort
- Clean root directory (no timestamped run directories cluttering root)
- Automatic organization (no manual sorting needed)

**Files**:
- `TRAINING/orchestration/intelligent_trainer.py` - RESULTS directory logic, cohort-based organization

### Integrated Config Backups

**Backup Integration**
- Config backups now stored in run directory: `RESULTS/{cohort_id}/{run_name}/backups/`
- Organized by target: `backups/{target}/{timestamp}/`
- Moves with run directory when organized by cohort
- Replaces separate `CONFIG/backups/` structure (maintains backward compatibility)

**Backup Structure**
```
RESULTS/{cohort_id}/{run_name}/backups/
└── {target}/
    └── {timestamp}/
        ├── excluded_features.yaml
        ├── feature_registry.yaml
        └── manifest.json
```

**Benefits**
- Backups stored with run artifacts (everything in one place)
- Cohort-organized (backups grouped with their cohort)
- Easy debugging (see config state for each run)
- Automatic (no manual organization needed)

**Files**:
- `TRAINING/common/leakage_auto_fixer.py` - Added `output_dir` parameter, integrated backup storage
- `TRAINING/ranking/predictability/model_evaluation.py` - Passes `output_dir` to LeakageAutoFixer

### Enhanced Metadata

**Symbols List in Metadata**
- `metadata.json` now includes full `symbols` list (sorted, deduplicated)
- Essential for debugging cohort behavior ("why did this cohort behave weirdly?")
- Stable git diffs (sorted list means minimal changes in version control)
- Complete cohort manifest (not just counts)

**Metadata Structure**
```json
{
  "schema_version": 1,
  "cohort_id": "cs_2025Q2_min_cs3_max1000_v1_bdbeb515",
  "run_id": "2025-12-11_23-41-32-644231",
  "stage": "TARGET_RANKING",
  "N_effective": 24680,
  "n_symbols": 5,
  "symbols": ["AAPL", "AMZN", "GOOGL", "MSFT", "TSLA"],  // NEW
  "date_start": "2025-05-29T16:25:00",
  "date_end": "2025-08-29T14:35:00",
  ...
}
```

**Files**:
- `TRAINING/utils/reproducibility_tracker.py` - Added symbols extraction and storage
- `TRAINING/utils/cohort_metadata_extractor.py` - Extracts and formats symbols list

### Unified Metadata Extractor

**Centralized Utility**
- New `TRAINING/utils/cohort_metadata_extractor.py` utility
- Centralized logic for extracting cohort metadata from various data sources
- Used across target ranking, feature selection, and training modules
- Reduces code duplication and ensures consistency

**Features**
- Handles multiple data sources: numpy arrays, pandas DataFrames, lists, dicts
- Extracts: `N_effective_cs`, `n_symbols`, `symbols`, `date_range`, `cs_config`
- Formats metadata for reproducibility tracker (splits into `metrics` and `additional_data`)
- Robust error handling with fallbacks

**Usage Pattern**
```python
from TRAINING.utils.cohort_metadata_extractor import extract_cohort_metadata, format_for_reproducibility_tracker

cohort_metadata = extract_cohort_metadata(
    X=X, symbols=symbols, time_vals=time_vals, mtf_data=mtf_data,
    min_cs=min_cs, max_cs_samples=max_cs_samples
)
cohort_metrics, cohort_additional_data = format_for_reproducibility_tracker(cohort_metadata)
```

**Files**:
- `TRAINING/utils/cohort_metadata_extractor.py` - **NEW** - Complete utility module
- `TRAINING/ranking/predictability/model_evaluation.py` - Uses unified extractor
- `TRAINING/ranking/feature_selector.py` - Uses unified extractor
- `TRAINING/training_strategies/training.py` - Uses unified extractor

### Immediate File Writes

**Real-Time Visibility**
- All reproducibility files flushed to disk immediately with `fsync()`
- Real-time visibility during runs (not waiting until end)
- INFO-level logging for file operations
- Files written per-target/per-feature/per-model (not batched at end)

**Implementation**
- `json.dump()` followed by `f.flush()` and `os.fsync(f.fileno())`
- `df.to_parquet()` followed by `os.sync()` for system-wide sync
- All file operations wrapped in try/except with proper error classification

**Files**:
- `TRAINING/utils/reproducibility_tracker.py` - Immediate writes for all JSON and parquet files

---

## Changed

### ReproducibilityTracker

**Cohort-Aware as Default**
- Default mode is now cohort-aware (`cohort_aware=True` by default)
- Enhanced logging with INFO-level messages for mode selection
- Better error classification (`IO_ERROR`, `SERIALIZATION_ERROR`, `UNKNOWN_ERROR`)
- Operational metrics in `stats.json` for visibility
- Immediate file writes with `flush()` and `os.fsync()`

**Enhanced Logging**
- INFO-level messages when cohort-aware mode is active
- INFO-level messages when falling back to legacy mode (with explanation)
- INFO-level messages when files are written
- Clear visibility into which mode is being used and why

**Error Handling**
- Comprehensive try/except blocks with proper error classification
- Never breaks the main pipeline (graceful degradation)
- Detailed error logging with error types
- Operational metrics track error counts

**Files**:
- `TRAINING/utils/reproducibility_tracker.py` - Major refactor for cohort-aware mode

### IntelligentTrainer

**RESULTS Directory Organization**
- Output directories automatically go to `RESULTS/` for all runs
- Automatic cohort-based organization after first target
- Cache attributes initialized early to prevent AttributeError
- Runs start in `RESULTS/_pending/` and move to `RESULTS/{cohort_id}/` after cohort identified

**Cohort Organization Logic**
- `_organize_by_cohort()` method extracts cohort_id from REPRODUCIBILITY directory
- Moves entire run directory (including all subdirectories) to cohort location
- Updates all internal paths (cache_dir, output_dir, etc.)
- Handles edge cases (directory already exists, missing cohort info)

**Files**:
- `TRAINING/orchestration/intelligent_trainer.py` - RESULTS organization, cohort sorting, cache initialization fix

### LeakageAutoFixer

**Integrated Backups**
- Accepts `output_dir` parameter to store backups in run directory
- Backups integrated into RESULTS structure
- Maintains backward compatibility with `CONFIG/backups/` if `output_dir` not provided
- Backups organized by target within run directory

**Backup Directory Logic**
- If `output_dir` provided: `{output_dir}/backups/{target}/{timestamp}/`
- If `output_dir` not provided: `CONFIG/backups/{target}/{timestamp}/` (legacy)
- Backups move with run directory when organized by cohort

**Files**:
- `TRAINING/common/leakage_auto_fixer.py` - Added `output_dir` parameter, integrated backup storage

### All Pipeline Modules

**Unified Metadata Extraction**
- Target ranking, feature selection, and training now use unified `cohort_metadata_extractor`
- Consistent cohort metadata extraction across all stages
- All modules store `cohort_context` after data preparation for later use

**Pattern Used**
1. Store `cohort_context` after data preparation
2. Extract metadata using `extract_cohort_metadata()`
3. Format using `format_for_reproducibility_tracker()`
4. Pass to `ReproducibilityTracker.log_comparison()`

**Files**:
- `TRAINING/ranking/predictability/model_evaluation.py` - Uses unified extractor, stores cohort_context
- `TRAINING/ranking/feature_selector.py` - Uses unified extractor, stores cohort_context
- `TRAINING/training_strategies/training.py` - Uses unified extractor, stores cohort_context

---

## Fixed

### Cache Initialization Bug

**Issue**: `AttributeError: 'IntelligentTrainer' object has no attribute 'target_ranking_cache'`
- Cache attributes were initialized at the end of `__init__`, but `_organize_by_cohort()` could return early
- Attributes were missing when methods tried to use them

**Fix**: 
- Moved cache initialization to right after `cache_dir` is set
- Cache attributes now always initialized before any method uses them
- Updated cache paths when run directory is moved to cohort location

**Files**:
- `TRAINING/orchestration/intelligent_trainer.py` - Fixed cache initialization order

---

## Files Changed

### New Files
- `TRAINING/utils/cohort_metadata_extractor.py` - Unified metadata extraction utility (284 lines)
- `DOCS/03_technical/implementation/COHORT_AWARE_REPRODUCIBILITY.md` - Complete guide
- `DOCS/03_technical/implementation/COHORT_AWARE_REPRODUCIBILITY_IMPLEMENTATION.md` - Implementation details
- `DOCS/03_technical/implementation/REPRODUCIBILITY_API.md` - API reference
- `DOCS/03_technical/implementation/REPRODUCIBILITY_ERROR_HANDLING.md` - Error handling guide
- `DOCS/03_technical/implementation/REPRODUCIBILITY_IMPROVEMENTS.md` - Improvements summary
- `DOCS/03_technical/implementation/REPRODUCIBILITY_SELF_TEST.md` - Self-test checklist
- `DOCS/03_technical/implementation/REPRODUCIBILITY_STRUCTURE.md` - Directory structure guide

### Modified Files
- `TRAINING/utils/reproducibility_tracker.py` - Major refactor (+1475 lines, cohort-aware implementation)
- `TRAINING/orchestration/intelligent_trainer.py` - RESULTS organization, cohort sorting, cache fix (+80 lines)
- `TRAINING/ranking/predictability/model_evaluation.py` - Unified extractor, output_dir to LeakageAutoFixer (+77 lines)
- `TRAINING/ranking/feature_selector.py` - Unified extractor, cohort_context storage (+84 lines)
- `TRAINING/training_strategies/training.py` - Unified extractor, cohort_context storage (+63 lines)
- `TRAINING/common/leakage_auto_fixer.py` - Integrated backups, output_dir support (+53 lines)
- `CONFIG/training_config/safety_config.yaml` - Updated comments, cohort_aware default
- `CHANGELOG.md` - Added highlights section
- `DOCS/02_reference/changelog/2025-12-11.md` - Added late section
- `DOCS/01_tutorials/training/INTELLIGENT_TRAINING_TUTORIAL.md` - Updated output structure
- `DOCS/03_technical/implementation/COHORT_AWARE_REPRODUCIBILITY.md` - Updated storage structure
- `DOCS/03_technical/implementation/REPRODUCIBILITY_STRUCTURE.md` - Updated with RESULTS structure

---

## Configuration Changes

### safety_config.yaml

**Updated Comments**
- Clarified that `cohort_aware` defaults to `true` and is recommended
- Added explanation of cohort-aware mode benefits
- Updated threshold documentation

**Default Values**
- `cohort_aware: true` (was configurable, now default)
- `n_ratio_threshold: 0.90` (90% overlap required for comparability)

---

## Documentation Updates

### New Documentation
- **Cohort-Aware Reproducibility Guide** - Complete overview of the system
- **Reproducibility Structure** - Detailed directory structure with RESULTS organization
- **Reproducibility API** - API reference for developers
- **Reproducibility Error Handling** - Error classification and handling guide
- **Reproducibility Improvements** - Summary of improvements
- **Reproducibility Self-Test** - Checklist for validation

### Updated Documentation
- **Intelligent Training Tutorial** - Updated output structure section with RESULTS organization
- **Cohort-Aware Reproducibility** - Updated storage structure, added symbols field
- **Reproducibility Structure** - Updated with RESULTS directory structure and metadata format

---

## Migration Notes

### For Existing Users

**Backward Compatibility**
- Legacy mode still supported (set `cohort_aware: false` in config)
- Existing `CONFIG/backups/` structure still works if `output_dir` not provided to LeakageAutoFixer
- Old reproducibility logs still readable

**New Behavior**
- All new runs automatically use cohort-aware mode (default)
- All runs automatically go to `RESULTS/` directory
- Backups automatically integrated into run directory (if `output_dir` provided)

**No Action Required**
- System automatically handles migration
- Existing runs remain in their original locations
- New runs use new structure automatically

---

## Testing

### Verified
- ✅ Cohort metadata extraction from various data sources
- ✅ Symbols list extraction and formatting
- ✅ RESULTS directory organization
- ✅ Backup integration
- ✅ Immediate file writes
- ✅ Cache initialization fix
- ✅ All modules use unified extractor

### Test Coverage
- Unit tests for `cohort_metadata_extractor.py` (extraction logic)
- Integration tests for RESULTS organization
- End-to-end test for full pipeline with cohort-aware tracking

---

## Related

- [Changelog Index](README.md)
- [Root Changelog](../../../../CHANGELOG.md)
- [2025-12-11](2025-12-11.md)
- [Cohort-Aware Reproducibility Guide](../../03_technical/implementation/COHORT_AWARE_REPRODUCIBILITY.md)
- [Reproducibility Structure Guide](../../03_technical/implementation/REPRODUCIBILITY_STRUCTURE.md)
